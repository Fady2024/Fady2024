name: Update README with Latest Projects

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight UTC
  workflow_dispatch:  # Allows manual trigger
  push:
    branches: [main]

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch Repos and Update README
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Language to badge mapping
            const langBadges = {
              'TypeScript': '![TypeScript](https://img.shields.io/badge/-TypeScript-3178C6?style=flat-square&logo=typescript&logoColor=white)',
              'JavaScript': '![JavaScript](https://img.shields.io/badge/-JavaScript-F7DF1E?style=flat-square&logo=javascript&logoColor=black)',
              'Dart': '![Dart](https://img.shields.io/badge/-Dart-0175C2?style=flat-square&logo=dart&logoColor=white)',
              'C#': '![C#](https://img.shields.io/badge/-C%23-239120?style=flat-square&logo=csharp&logoColor=white)',
              'C++': '![C++](https://img.shields.io/badge/-C++-00599C?style=flat-square&logo=cplusplus&logoColor=white)',
              'C': '![C](https://img.shields.io/badge/-C-A8B9CC?style=flat-square&logo=c&logoColor=black)',
              'Python': '![Python](https://img.shields.io/badge/-Python-3776AB?style=flat-square&logo=python&logoColor=white)',
              'Java': '![Java](https://img.shields.io/badge/-Java-007396?style=flat-square&logo=openjdk&logoColor=white)',
              'Kotlin': '![Kotlin](https://img.shields.io/badge/-Kotlin-7F52FF?style=flat-square&logo=kotlin&logoColor=white)',
              'Swift': '![Swift](https://img.shields.io/badge/-Swift-FA7343?style=flat-square&logo=swift&logoColor=white)',
              'Go': '![Go](https://img.shields.io/badge/-Go-00ADD8?style=flat-square&logo=go&logoColor=white)',
              'Rust': '![Rust](https://img.shields.io/badge/-Rust-000000?style=flat-square&logo=rust&logoColor=white)',
              'PHP': '![PHP](https://img.shields.io/badge/-PHP-777BB4?style=flat-square&logo=php&logoColor=white)',
              'Ruby': '![Ruby](https://img.shields.io/badge/-Ruby-CC342D?style=flat-square&logo=ruby&logoColor=white)',
              'HTML': '![HTML](https://img.shields.io/badge/-HTML-E34F26?style=flat-square&logo=html5&logoColor=white)',
              'CSS': '![CSS](https://img.shields.io/badge/-CSS-1572B6?style=flat-square&logo=css3&logoColor=white)',
              'SCSS': '![SCSS](https://img.shields.io/badge/-SCSS-CC6699?style=flat-square&logo=sass&logoColor=white)',
              'Shell': '![Shell](https://img.shields.io/badge/-Shell-4EAA25?style=flat-square&logo=gnubash&logoColor=white)',
              'PowerShell': '![PowerShell](https://img.shields.io/badge/-PowerShell-5391FE?style=flat-square&logo=powershell&logoColor=white)',
              'Vue': '![Vue](https://img.shields.io/badge/-Vue-4FC08D?style=flat-square&logo=vuedotjs&logoColor=white)',
              'Jupyter Notebook': '![Jupyter](https://img.shields.io/badge/-Jupyter-F37626?style=flat-square&logo=jupyter&logoColor=white)',
              'Assembly': '![Assembly](https://img.shields.io/badge/-Assembly-654FF0?style=flat-square&logo=assemblyscript&logoColor=white)',
            };
            
            // Fetch user's public repos
            const { data: repos } = await github.rest.repos.listForUser({
              username: 'fady2024',
              sort: 'updated',
              direction: 'desc',
              per_page: 100,
              type: 'owner'
            });
            
            // Filter out the profile repo and forks
            const filteredRepos = repos.filter(repo => 
              repo.name !== 'Fady2024' && 
              !repo.fork &&
              !repo.archived
            ).slice(0, 6);
            
            // Generate table rows
            let tableContent = '| Project | Description | Tech |\n|---------|-------------|------|\n';
            
            filteredRepos.forEach(repo => {
              const name = repo.name;
              const desc = repo.description || 'ðŸ“¦ Project';
              const lang = repo.language || 'Code';
              const badge = langBadges[lang] || `![${lang}](https://img.shields.io/badge/-${lang}-gray?style=flat-square)`;
              
              tableContent += `| [**${name}**](${repo.html_url}) | ${desc} | ${badge} |\n`;
            });
            
            // Read current README
            let readme = fs.readFileSync('readme.md', 'utf8');
            
            // Replace content between markers
            const startMarker = '<!-- PROJECTS:START -->';
            const endMarker = '<!-- PROJECTS:END -->';
            const regex = new RegExp(`${startMarker}[\\s\\S]*${endMarker}`, 'g');
            
            const newContent = `${startMarker}\n${tableContent}${endMarker}`;
            readme = readme.replace(regex, newContent);
            
            fs.writeFileSync('readme.md', readme);
            console.log('README updated with', filteredRepos.length, 'projects');

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add readme.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ”„ Auto-update projects section" && git push)
