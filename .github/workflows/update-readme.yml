name: Update README with Latest Projects

on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight UTC
  workflow_dispatch:  # Allows manual trigger
  push:
    branches: [main]

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch Repos and Update README
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Fetch user's public repos
            const { data: repos } = await github.rest.repos.listForUser({
              username: 'fady2024',
              sort: 'updated',
              direction: 'desc',
              per_page: 100,
              type: 'owner'
            });
            
            // Filter out the profile repo and forks
            const filteredRepos = repos.filter(repo => 
              repo.name !== 'Fady2024' && 
              !repo.fork &&
              !repo.archived
            ).slice(0, 6);
            
            // Generate repo cards HTML
            let projectsHtml = '<div align="center">\n\n';
            
            filteredRepos.forEach((repo, index) => {
              const card = `<a href="${repo.html_url}">
              <img src="https://github-readme-stats.vercel.app/api/pin/?username=fady2024&repo=${repo.name}&theme=tokyonight&border_color=6e5494&bg_color=0d1117&title_color=58a6ff&icon_color=58a6ff" />
            </a>`;
              projectsHtml += card + '\n';
              if ((index + 1) % 2 === 0 && index < filteredRepos.length - 1) {
                projectsHtml += '\n';
              }
            });
            
            projectsHtml += '\n</div>\n\n';
            projectsHtml += `<p align="center">
              <a href="https://github.com/fady2024?tab=repositories">
                <img src="https://img.shields.io/badge/ðŸ”—_View_All_Projects-0d1117?style=for-the-badge&logo=github&logoColor=white" />
              </a>
            </p>`;
            
            // Read current README
            let readme = fs.readFileSync('readme.md', 'utf8');
            
            // Replace content between markers
            const startMarker = '<!-- PROJECTS:START -->';
            const endMarker = '<!-- PROJECTS:END -->';
            const regex = new RegExp(`${startMarker}[\\s\\S]*${endMarker}`, 'g');
            
            const newContent = `${startMarker}\n${projectsHtml}\n${endMarker}`;
            readme = readme.replace(regex, newContent);
            
            fs.writeFileSync('readme.md', readme);
            console.log('README updated with', filteredRepos.length, 'projects');

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add readme.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ”„ Auto-update projects section" && git push)
